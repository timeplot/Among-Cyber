<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>AMONG US CYBER ‚Äî Login</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-game-db.js"></script>
    
    <style>
        body {
            text-align: center;
            font-size: xx-large;
            font-style: normal;
            font-family: monospace;
            background-color: black;
            color: chartreuse;
            margin: 0;
            text-shadow: 2px 5px 2px darkgreen;
            overflow: hidden;
        }
        button {
            font-size: xx-large;
            padding: 15px 30px;
            border-color: chartreuse;
            background-color: darkgreen;
            font-family: monospace;
            font-weight: 700;
            color: white;
            border-radius: 10px;
            border: 2px solid chartreuse;
            cursor: pointer;
        }
        input {
            color: white;
            background-color: black;
            border-color: darkgreen;
            font-family: monospace;
            font-weight: 700;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: x-large;
            border: 2px solid darkgreen;
        }
        form { margin-top: 30px; z-index: 10; position: relative; }
        label { display:block; margin: 8px 0; font-size: large; color: chartreuse; }

        /* falling digits */
        .digit {
            position: absolute;
            top: -20px;
            font-size: 16px;
            text-shadow: 0 0 5px #39ff14, 0 0 10px #39ff14;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            pointer-events: none;
            opacity: 0.9;
        }
        @keyframes fall {
            0% { top: -20px; opacity: 1; transform: translateY(0); }
            100% { top: 100vh; opacity: 0; transform: translateY(0); }
        }

        h1 { margin-top: 18px; }
        #msg { color:#ff6b6b; font-size: medium; margin-top:12px; }
        .demo-users { 
            margin-top: 20px; 
            font-size: medium; 
            color: #8fbfcf;
            text-align: left;
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 1px solid darkgreen;
        }
        .demo-users h3 { 
            color: chartreuse; 
            text-align: center;
            margin-bottom: 10px;
        }
        .user-list { 
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: small;
        }
        .impostor { color: #ff6b6b; }
        .crewmate { color: #6bc4ff; }
        
        .game-info {
            background: rgba(0, 100, 0, 0.2);
            border: 1px solid darkgreen;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 500px;
            font-size: medium;
        }
    </style>
</head>

<body>
    <h1>AMONG CYBER</h1>

    <form id="Among">
        <label for="Username">Username:</label>
        <input type="text" id="Username" autocomplete="username" required>

        <label for="Password">Password:</label>
        <input type="password" id="Password" autocomplete="current-password" required>

        <br><br>
        <button type="submit">LOG IN</button>
        <div id="msg"></div>
    </form>

    <div class="game-info">
        <h3>üéÆ Game Rules</h3>
        <p><strong>Crewmates Win:</strong> Complete all tasks OR vote out impostors</p>
        <p><strong>Impostors Win:</strong> Eliminate crewmates OR stop task completion</p>
        <p><strong>Max Kills:</strong> 3 per round ‚Ä¢ <strong>Players:</strong> 8 total</p>
    </div>

    <div class="demo-users">
        <h3>üéÆ Demo Users (Click to auto-fill)</h3>
        <div class="user-list">
            <div class="impostor" onclick="fillDemo('Red', 'red123')">üïµÔ∏è Red (Impostor)</div>
            <div class="crewmate" onclick="fillDemo('Blue', 'blue123')">üë®‚ÄçüöÄ Blue (Crewmate)</div>
            <div class="impostor" onclick="fillDemo('Orange', 'orange123')">üïµÔ∏è Orange (Impostor)</div>
            <div class="crewmate" onclick="fillDemo('Green', 'green123')">üë®‚ÄçüöÄ Green (Crewmate)</div>
            <div class="crewmate" onclick="fillDemo('Yellow', 'yellow123')">üë®‚ÄçüöÄ Yellow (Crewmate)</div>
            <div class="crewmate" onclick="fillDemo('Purple', 'purple123')">üë®‚ÄçüöÄ Purple (Crewmate)</div>
            <div class="crewmate" onclick="fillDemo('Pink', 'pink123')">üë®‚ÄçüöÄ Pink (Crewmate)</div>
            <div class="crewmate" onclick="fillDemo('White', 'white123')">üë®‚ÄçüöÄ White (Crewmate)</div>
        </div>
        <p style="text-align: center; margin-top: 10px; font-size: smaller;">
            Or create new account with any username/password
        </p>
    </div>
    <script>
        // Falling binary effect
        (function makeDigits(){
            const digitCount = 200;
            const screenWidth = window.innerWidth || document.documentElement.clientWidth;
            for (let i = 0; i < digitCount; i++) {
                const span = document.createElement('span');
                span.className = 'digit';
                span.style.left = Math.random() * screenWidth + 'px';
                span.style.fontSize = (10 + Math.random() * 22) + 'px';
                span.style.animationDuration = (3 + Math.random() * 6) + 's';
                span.style.animationDelay = (Math.random() * 5) + 's';
                span.textContent = Math.random() > 0.5 ? '0' : '1';
                span.style.transform = `translateX(${(Math.random()-0.5)*30}px)`;
                document.body.appendChild(span);
            }
        })();
    
        // Demo user auto-fill
        function fillDemo(username, password) {
            document.getElementById('Username').value = username;
            document.getElementById('Password').value = password;
        }
    
        // Test Firebase connection
        function testFirebase() {
            console.log('Testing Firebase connection for among-ussy...');
            console.log('Firebase defined:', typeof firebase !== 'undefined');
            if (typeof firebase !== 'undefined') {
                console.log('Firebase apps:', firebase.apps.length);
                console.log('Firebase DB:', typeof firebase.database !== 'undefined');
                console.log('firebaseDB:', typeof firebaseDB !== 'undefined');
                
                // Test database connection
                if (typeof firebase.database !== 'undefined') {
                    firebase.database().ref('test').set({timestamp: Date.now()})
                        .then(() => console.log('‚úÖ Firebase write successful!'))
                        .catch(err => console.error('‚ùå Firebase error:', err));
                }
            }
        }
    
        // Enhanced login system with Firebase
        document.getElementById('Among').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('Username').value.trim();
            const password = document.getElementById('Password').value;
            const msg = document.getElementById('msg');
    
            // Test Firebase first
            testFirebase();
    
            msg.textContent = 'Connecting to server...';
            msg.style.color = 'chartreuse';
    
            try {
                // Check if Firebase is available
                if (typeof firebase === 'undefined' || typeof firebaseDB === 'undefined') {
                    throw new Error('Firebase not loaded. Please refresh the page.');
                }
    
                let player;
                
                // Try to authenticate with Firebase
                const existingPlayer = await firebaseDB.authenticate(username, password);
                if (existingPlayer) {
                    player = existingPlayer;
                    await firebaseDB.updatePlayerStatus(player.id, 'online');
                    msg.textContent = `Welcome back, ${player.username}!`;
                } else {
                    // Register new player
                    player = await firebaseDB.registerPlayer(username, password);
                    msg.textContent = `Welcome, ${player.username}! Role: ${player.role}`;
                }
    
                // Store current player locally
                localStorage.setItem('currentPlayer', JSON.stringify(player));
                
                // Check if game has enough players
                const players = await firebaseDB.getPlayers();
                const onlinePlayers = Object.values(players).filter(p => p.status === 'online');
                
                if (onlinePlayers.length >= 8) {
                    // Game can start - roles will be assigned automatically
                    msg.textContent += ' Game starting! Assigning roles...';
                    
                    // Small delay to show message
                    setTimeout(() => {
                        redirectPlayer(player);
                    }, 2000);
                } else {
                    // Waiting for more players
                    msg.textContent += ` Waiting for players... (${onlinePlayers.length}/8)`;
                    
                    // Redirect to lobby or first task based on role assignment
                    setTimeout(() => {
                        redirectPlayer(player);
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                msg.textContent = 'Error: ' + error.message;
                msg.style.color = '#ff6b6b';
            }
        });
    
        function redirectPlayer(player) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; color: chartreuse;">
                    <h2>Welcome, ${player.username}!</h2>
                    <p>Role: <strong>${player.role.toUpperCase()}</strong></p>
                    <p>Score: ${player.score} | Tasks: ${player.completedTasks.length}/3</p>
                    <p>Connecting to game server...</p>
                    <div style="margin-top: 20px;">
                        ${player.role === 'impostor' ? 
                          'üïµÔ∏è You are an IMPOSTOR - Sabotage and eliminate crewmates!' : 
                          'üë®‚ÄçüöÄ You are a CREWMATE - Complete tasks and find the impostor!'}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                if (player.role === 'impostor') {
                    location.href = 'impostor-panel.html';
                } else {
                    // Crewmates go to task selection based on progress
                    if (player.completedTasks.length >= 3) {
                        location.href = 'meeting-chat.html';
                    } else if (player.completedTasks.length >= 2) {
                        location.href = 'Challenge-3.html';
                    } else if (player.completedTasks.length >= 1) {
                        location.href = 'Challenge-2.html';
                    } else {
                        location.href = 'main.html';
                    }
                }
            }, 3000);
        }
    
        // Check if player was eliminated
        async function checkEliminationStatus() {
            const currentPlayer = JSON.parse(localStorage.getItem('currentPlayer'));
            if (currentPlayer && typeof firebaseDB !== 'undefined') {
                try {
                    const data = await firebaseDB.getData();
                    const playerInDB = data.players[currentPlayer.id];
                    if (playerInDB && playerInDB.status === 'eliminated') {
                        localStorage.removeItem('currentPlayer');
                        alert('üíÄ You have been eliminated! Please login again.');
                    }
                } catch (error) {
                    console.log('Could not check elimination status:', error);
                }
            }
        }
    
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page loaded, testing Firebase for among-ussy...');
            testFirebase();
            
            await checkEliminationStatus();
            
            // Auto-fill if remembered
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                const [user, pass] = rememberedUser.split(':');
                document.getElementById('Username').value = user;
                document.getElementById('Password').value = pass;
            }
        });
    
        // Enter key to submit
        document.getElementById('Password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('Among').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>