<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Phishing Mail - Drag & Sort</title>
<style>
  :root{
    --bg:#000;
    --neon:#00ff66;
    --muted:#8fbfcf;
    --danger:#ff5c6c;
  }
  html,body{height:100%;margin:0;font-family:monospace;background:
    radial-gradient(1200px 600px at 10% 10%, black), linear-gradient(to top, #001100, black);
    color:var(--neon); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  #taskbar { background: rgba(10,10,10,0.95); color: var(--neon); padding: 10px 14px; display:flex; gap:12px; align-items:center; border-bottom:1px solid rgba(0,255,150,0.06); position: fixed; top:0; left:0; width:100%; box-sizing:border-box; z-index:1000; }
  #taskbar > div { display:flex; gap:8px; align-items:center; font-size:14px; }
  #taskbar button { background:#07120a; color:var(--neon); border:1px solid rgba(0,255,150,0.12); border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:700; }
  main { padding: 106px 20px 40px; max-width:1100px; margin:0 auto; }
  h1{ text-align:center; color:var(--neon); margin:6px 0 8px; }
  p{ text-align:center; color:var(--muted); margin:0 0 18px; }
  .container{ display:flex; gap:20px; align-items:flex-start; justify-content:center; flex-wrap:wrap; }
  .column{ background: rgba(5,10,5,0.8); padding:12px; border-radius:10px; flex:1 1 320px; min-height:380px; border:2px dashed rgba(0,255,150,0.06); box-sizing:border-box; }
  .column h2{ text-align:center; margin:6px 0 10px; color:var(--neon); font-size:16px; }
  #emails{ flex-basis:100%; margin-top:20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; transition:all 300ms ease; }
  .mail{ background: rgba(15,20,15,0.95); border-radius:8px; padding:10px; color:var(--neon); min-width:260px; max-width:360px; cursor:grab; box-shadow:0 6px 18px rgba(0,255,150,0.02); border-left:3px solid rgba(0,255,150,0.05); user-select:none; transition: transform 300ms ease, opacity 200ms ease; }
  .mail.dragging{ opacity:0.6; transform:scale(1.02); }
  #resultDisplay{ margin-top:16px; text-align:center; color:var(--neon); font-weight:700; font-size:16px; min-height:36px; }
  .msg-error{ color:#ff7070; font-weight:700; margin-top:8px; }
  .msg-success{ color:#7cffb2; font-weight:700; margin-top:8px; }
  #sabotageBanner {
    position: fixed;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1200;
    background: linear-gradient(90deg, rgba(255,90,90,0.95), rgba(255,50,80,0.95));
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 800;
    display: none;
    box-shadow: 0 10px 30px rgba(255, 40, 60, 0.12);
    animation: blink 1s linear infinite;
  }
  @keyframes blink { 0% {opacity:1} 50% {opacity:0.85} 100% {opacity:1} }

  /* shuffle visual class */
  .shuffling {
    opacity: 0.6;
    transform: scale(0.995);
    transition: transform 300ms ease, opacity 300ms ease;
  }

  @media (max-width:820px){ .mail{ min-width:90%; max-width:calc(100% - 40px); } .container{ padding:0 10px; } }
</style>
</head>
<body>
  <div id="taskbar" role="region" aria-label="Controls">
    <div>Time Remaining: <span id="timer">05:00</span></div>
    <div>Progress: <span id="progress">0%</span></div>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button id="resetBtn" type="button">Reset</button>
      <button id="submitBtn" type="button">Submit</button>
    </div>
  </div>

  <div id="sabotageBanner" role="status" aria-live="assertive">⚠️ IMPOSTOR SABOTAGE DETECTED — MAIL ORDER SHUFFLED</div>

  <main>
    <h1>Drag and Drop: Sort Phishing Emails</h1>
    <p>Drag each email into the correct column: <strong>Real Email</strong> or <strong>Phishing Email</strong></p>

    <div class="container" aria-live="polite">
      <div class="column" id="real" aria-label="Real emails drop zone"><h2>Real Email</h2></div>
      <div class="column" id="phishing" aria-label="Phishing emails drop zone"><h2>Phishing Email</h2></div>
      <div id="emails" aria-label="Unsorted emails area"></div>
    </div>

    <div id="controls" aria-hidden="true"></div>
    <div id="resultDisplay" aria-live="polite"></div>
  </main>

<script>
/* CONFIG */
const redirectUrl = "inter.html"; // change to final page when all correct

/* EMAIL DATA (same as your original set) */
const emails = [
  {id:1, text: 'Subject: Invoice INV-2025-774 — Immediate payment required', type:'phishing'},
  {id:2, text: 'Subject: Action Required — Your account password expires today', type:'phishing'},
  {id:3, text: 'Subject: CONGRATULATIONS — You’ve been selected for $1,000 prize!', type:'phishing'},
  {id:4, text: 'Subject: URGENT: New bank details for your upcoming payment to VendorCorp', type:'phishing'},
  {id:5, text: 'Subject: URGENT — Wire transfer request, confidential', type:'phishing'},
  {id:6, text: 'Subject: A document has been shared with you — Project Plan v2', type:'phishing'},
  {id:7, text: 'Subject: Mandatory All-Staff Meeting — Please Accept', type:'phishing'},
  {id:8, text: 'Subject: Important — Tax refund requires confirmation', type:'phishing'},
  {id:9, text: 'Subject: Security Alert — Verify your account now or it will be suspended', type:'phishing'},
  {id:10, text: 'Subject: Delivery attempt failed — redelivery fee required', type:'phishing'},
  {id:11, text: 'Subject: Reminder — Invoice INV-3345 due 15 Oct 2025', type:'real'},
  {id:12, text: 'Subject: Action required — Password expiry for alice.khan@gemsae.com', type:'real'},
  {id:13, text: 'Subject: Regional Merit Scholarship — shortlist notification', type:'real'},
  {id:14, text: 'Subject: Invitation to panel: “Emerging Technologies in Education” — 10 Nov 2025', type:'real'},
  {id:15, text: 'Subject: Payment received — INV-7812, Ref: PAY-2025-0987', type:'real'},
  {id:16, text: 'Subject: FY2025 Compliance Declaration — please complete by 31 Oct 2025', type:'real'},
  {id:17, text: 'Subject: Quotation for Signage — site visit follow-up & deposit details', type:'real'},
  {id:18, text: 'Subject: Matching campaign this weekend — support our scholarship fund', type:'real'},
  {id:19, text: 'Subject: Shared drive “Curriculum” at 92% quota — recommended actions', type:'real'},
  {id:20, text: 'Subject: Refunds for canceled session — timeline & support', type:'real'}
];

/* UI ELEMENTS */
const emailsContainer = document.getElementById('emails');
const timerEl = document.getElementById('timer');
const progressEl = document.getElementById('progress');
const resultEl = document.getElementById('resultDisplay');
const resetBtn = document.getElementById('resetBtn');
const submitBtn = document.getElementById('submitBtn');
const sabotageBanner = document.getElementById('sabotageBanner');

/* RENDER */
function createMailElement(mail){
  const div = document.createElement('div');
  div.className = 'mail';
  div.draggable = true;
  div.id = 'mail-' + mail.id;
  div.textContent = mail.text;
  div.dataset.type = mail.type;
  return div;
}
function renderEmails(order = null){
  emailsContainer.innerHTML = '';
  let list = [...emails];
  if(Array.isArray(order) && order.length === emails.length){
    // order is array of ids
    list = order.map(id => emails.find(m=>m.id===id));
  } else {
    list.sort(() => Math.random() - 0.5);
  }
  list.forEach(mail => emailsContainer.appendChild(createMailElement(mail)));
}
renderEmails();

/* DRAG & DROP */
let dragged = null;
document.addEventListener('dragstart', e => {
  if(e.target && e.target.classList.contains('mail')){
    dragged = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer?.setData('text/plain', e.target.id);
  }
});
document.addEventListener('dragend', e => {
  if(e.target && e.target.classList) e.target.classList.remove('dragging');
  dragged = null;
});
document.querySelectorAll('.column').forEach(col => {
  col.addEventListener('dragover', e => e.preventDefault());
  col.addEventListener('drop', e => {
    e.preventDefault();
    if(dragged){ col.appendChild(dragged); updateProgress(); }
    else {
      const id = (e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/plain')) || null;
      if(id){ const el = document.getElementById(id); if(el) col.appendChild(el); updateProgress(); }
    }
  });
});

/* PROGRESS */
function updateProgress(){
  const sorted = document.querySelectorAll('#real .mail, #phishing .mail').length;
  progressEl.textContent = Math.floor((sorted / emails.length) * 100) + '%';
}
updateProgress();

/* TIMER */
let timerInterval;
function startTimer(){
  clearInterval(timerInterval);
  let time = 300;
  timerEl.textContent = formatMMSS(time);
  timerInterval = setInterval(() => {
    time--;
    timerEl.textContent = formatMMSS(Math.max(0, time));
    if(time <= 0){
      clearInterval(timerInterval);
      resultEl.innerHTML = `<div class="msg-error">Time's up — you must correctly sort all emails to proceed.</div>`;
      submitBtn.disabled = false;
    }
  }, 1000);
}
function formatMMSS(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}
startTimer();

/* RESET */
resetBtn.addEventListener('click', () => {
  renderEmails();
  updateProgress();
  startTimer();
  resultEl.textContent = '';
  submitBtn.disabled = false;
});

/* SUBMIT: only proceed when ALL correct */
submitBtn.addEventListener('click', () => {
  submitBtn.disabled = true;
  clearInterval(timerInterval);

  let correct = 0;
  emails.forEach(mail => {
    const el = document.getElementById('mail-' + mail.id);
    if(el && el.parentElement && el.parentElement.id === mail.type) correct++;
  });
  const incorrect = emails.length - correct;

  if(correct === emails.length){
    resultEl.innerHTML = `
      <div class="msg-success">🟢 Perfect! All ${correct} correct — proceeding...</div>
      <div style="margin-top:8px; opacity:0.9;">Redirecting in <span id="redirCountdown">4</span> seconds...</div>
    `;
    let countdown = 4;
    const rc = document.getElementById('redirCountdown');
    const countdownInterval = setInterval(() => {
      countdown--;
      if(rc) rc.textContent = countdown;
      if(countdown <= 0){
        clearInterval(countdownInterval);
        const qs = `?score=${encodeURIComponent(correct)}&total=${encodeURIComponent(emails.length)}&correct=${encodeURIComponent(correct)}&incorrect=${encodeURIComponent(incorrect)}`;
        window.location.href = redirectUrl + qs;
      }
    }, 1000);
  } else {
    resultEl.innerHTML = `
      <div>🟢 Correct: <strong>${correct}</strong></div>
      <div>🔴 Incorrect: <strong>${incorrect}</strong></div>
      <div class="msg-error">You must get all ${emails.length} correct to proceed. Try again — submit re-enabled.</div>
    `;
    submitBtn.disabled = false;
  }
});

/* Accessibility keyboard fallback */
let keyboardGrab = null;
document.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    const focused = document.activeElement;
    if(focused && focused.classList && focused.classList.contains('mail')){
      keyboardGrab = focused;
      focused.style.outline = '2px dashed var(--neon)';
      e.preventDefault();
    }
  }
  if(e.key === 'Escape'){ if(keyboardGrab){ keyboardGrab.style.outline = ''; keyboardGrab = null; } }
  if(e.key === ' ' || e.key === 'Spacebar'){
    const focused = document.activeElement;
    if(focused && focused.classList && focused.classList.contains('column') && keyboardGrab){
      focused.appendChild(keyboardGrab);
      keyboardGrab.style.outline = '';
      keyboardGrab = null;
      updateProgress();
      e.preventDefault();
    }
  }
});
function makeFocusable(){ document.querySelectorAll('.mail').forEach(el => el.setAttribute('tabindex','0')); document.querySelectorAll('.column').forEach(el => el.setAttribute('tabindex','0')); }
makeFocusable();
const observer = new MutationObserver(() => makeFocusable());
observer.observe(emailsContainer, { childList: true, subtree: true });

/* ---------------------
   SABOTAGE LISTENER
   - reacts when impostor sets localStorage key 'sabotageTrigger'
   - expected value: timestamp (ms) string
   - performs visible shuffle animation and reorders cards
   --------------------- */

let lastSabotageTs = localStorage.getItem('lastHandledSabotage') || '0';

function visualShuffleAnimation(newOrderIds){
  // easy visual: add shuffling class, wait 350ms, reorder nodes, then remove class
  const container = emailsContainer;
  container.classList.add('shuffling');
  // fade out children slightly
  Array.from(container.children).forEach((c,i)=>{
    c.style.transition = `transform 300ms ease ${i*12}ms, opacity 250ms ease ${i*12}ms`;
    c.style.opacity = '0.4';
    c.style.transform = 'translateY(6px)';
  });
  setTimeout(()=> {
    // reorder DOM according to newOrderIds
    const idToNode = {};
    Array.from(container.children).forEach(node => { idToNode[node.id] = node; });
    newOrderIds.forEach(id => {
      const node = idToNode['mail-' + id];
      if(node) container.appendChild(node);
    });
    // restore visuals
    Array.from(container.children).forEach((c,i)=>{
      c.style.opacity = '';
      c.style.transform = '';
      c.style.transition = '';
    });
    container.classList.remove('shuffling');
  }, 350);
}

function performSabotage(sabotageTs){
  // prevent duplicate handling
  if(!sabotageTs) return;
  if(Number(sabotageTs) <= Number(lastSabotageTs)) return;
  lastSabotageTs = sabotageTs;
  localStorage.setItem('lastHandledSabotage', String(lastSabotageTs));

  // show banner
  sabotageBanner.style.display = 'block';
  setTimeout(()=> sabotageBanner.style.display = 'none', 6000);

  // compute new random order of ids (full shuffle)
  const ids = emails.map(e => e.id);
  for (let i = ids.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [ids[i], ids[j]] = [ids[j], ids[i]];
  }

  // animate & reorder
  visualShuffleAnimation(ids);

  // also update the internal emails ordering so new render respects order if needed
  const newEmails = ids.map(id => emails.find(m => m.id === id)).filter(Boolean);
  // replace emails array content
  emails.splice(0, emails.length, ...newEmails);

  // re-bind focusable elements after short delay
  setTimeout(()=> {
    makeFocusable();
  }, 700);
}

// Listen for storage events (triggered by other tabs)
window.addEventListener('storage', (ev) => {
  if(ev.key === 'sabotageTrigger') {
    performSabotage(ev.newValue);
  }
});

// Also check on load if a sabotage was triggered while this page was closed
window.addEventListener('DOMContentLoaded', () => {
  const pending = localStorage.getItem('sabotageTrigger');
  if(pending) performSabotage(pending);
});
</script>
</body>
</html>
